<div class="container-fluid">
  <div *ngIf="vecindario | async as vecindario">
    <mat-toolbar *ngIf="checkAdminBarrio(vecindario.admin) || this.user.admin">
      <div>
        <mat-slide-toggle (click)="toggleOculto(vecindario.comentarios_plaza)"
          [(ngModel)]="vecindario.comentarios_plaza">
          <span *ngIf="vecindario.comentarios_plaza">Comentarios Activados</span><span
            *ngIf="!vecindario.comentarios_plaza">Comentarios Desactivados</span>
        </mat-slide-toggle>
      </div>
      <span class="app-toolbar-filler"></span>
      <button color="primary" mat-button><i class="material-icons icono-titulo">add_photo_alternate</i> Subir
        banner</button>
    </mat-toolbar>
  </div>
  <br>
  <button mat-fab color="accent" class="pos-bottom-right" (click)="open()" matTooltip="Escribir en la Plaza">
    <i class="material-icons icono-boton">edit</i>
  </button>
  <div class="row justify-content-center" *ngIf="vecindario | async as vecindario">
    <div class="col-12 col-md-8 col-lg-6" *ngIf="checkAdminBarrio(vecindario.admin) || this.user.admin">
      <div class="alert alert-primary" role="alert">
        <h4 class="alert-heading">Banner en tu Comunidad!</h4>
        <p>En este espacio podemos agregar un banner publicitario de 600x300 pixeles para tu comunidad.</p>
        <hr>
        <p class="mb-0 text-right"><a class="btn btn-primary" href="#" role="button">Subir banner</a></p>
      </div>
    </div>
  </div>
  <br>
  <div class="row">
    <div class="col-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3 col-xl-6 offset-xl-3"
      style="padding-right: 0; padding-left: 0;">
      <mat-card>
        <mat-card-content>
          <app-categorias></app-categorias>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
  <div class="row" *ngIf="cargando">
    <div class="col-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3 col-xl-6 offset-xl-3"
      style="padding-right: 0; padding-left: 0;">
      <mat-card>
        <div class="timeline-wrapper" style="z-index: 999;">
          <div class="timeline-item" style="z-index: 999;">
            <div class="animated-background" style="z-index: 999;">
              <div class="background-masker header-top"></div>
              <div class="background-masker header-left"></div>
              <div class="background-masker header-right"></div>
              <div class="background-masker header-bottom"></div>
              <div class="background-masker subheader-left"></div>
              <div class="background-masker subheader-right"></div>
              <div class="background-masker subheader-bottom"></div>
              <div class="background-masker content-top"></div>
              <div class="background-masker content-first-end"></div>
              <div class="background-masker content-second-line"></div>
              <div class="background-masker content-second-end"></div>
              <div class="background-masker content-third-line"></div>
              <div class="background-masker content-third-end"></div>
            </div>
          </div>
        </div>
      </mat-card>
    </div>
    <div class="col-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3 col-xl-6 offset-xl-3"
      style="padding-right: 0; padding-left: 0;">
      <mat-card>
        <div class="timeline-wrapper" style="z-index: 999;">
          <div class="timeline-item" style="z-index: 999;">
            <div class="animated-background" style="z-index: 999;">
              <div class="background-masker header-top"></div>
              <div class="background-masker header-left"></div>
              <div class="background-masker header-right"></div>
              <div class="background-masker header-bottom"></div>
              <div class="background-masker subheader-left"></div>
              <div class="background-masker subheader-right"></div>
              <div class="background-masker subheader-bottom"></div>
              <div class="background-masker content-top"></div>
              <div class="background-masker content-first-end"></div>
              <div class="background-masker content-second-line"></div>
              <div class="background-masker content-second-end"></div>
              <div class="background-masker content-third-line"></div>
              <div class="background-masker content-third-end"></div>
            </div>
          </div>
        </div>
      </mat-card>
    </div>
    <div class="col-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3 col-xl-6 offset-xl-3"
      style="padding-right: 0; padding-left: 0;">
      <mat-card>
        <div class="timeline-wrapper" style="z-index: 999;">
          <div class="timeline-item" style="z-index: 999;">
            <div class="animated-background" style="z-index: 999;">
              <div class="background-masker header-top"></div>
              <div class="background-masker header-left"></div>
              <div class="background-masker header-right"></div>
              <div class="background-masker header-bottom"></div>
              <div class="background-masker subheader-left"></div>
              <div class="background-masker subheader-right"></div>
              <div class="background-masker subheader-bottom"></div>
              <div class="background-masker content-top"></div>
              <div class="background-masker content-first-end"></div>
              <div class="background-masker content-second-line"></div>
              <div class="background-masker content-second-end"></div>
              <div class="background-masker content-third-line"></div>
              <div class="background-masker content-third-end"></div>
            </div>
          </div>
        </div>
      </mat-card>
    </div>
  </div>
  <div class="row" *ngIf="noticias$ | async as noticias" #ventana>
    <div class="col-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3 col-xl-6 offset-xl-3"
      style="padding-right: 0; padding-left: 0;"
      *ngFor="let noticia of (noticias | slice:0:this.maxNoticias); trackBy: itemTrackBy">
      <mat-card *ngIf="!cargando">
        <mat-card-header>
          <img mat-card-avatar src="{{(noticia.userRef | doc | async)?.photoURL ||  '../../assets/user_google.jpg' }}">
          <mat-card-title>
            <a style="cursor: pointer; color:#007bff;">{{ (noticia.userRef | doc | async)?.displayName }}</a> escribiÃ³
            una publicaciÃ³n
          </mat-card-title>
          <mat-card-subtitle style="margin-top:-20px;">
            <small>
              ðŸ•š {{ noticia.creado | amTimeAgo }}
            </small>
          </mat-card-subtitle>
          <span class="app-toolbar-filler"></span>
          <mat-icon *ngIf="(authService.user | async)?.admin || (authService.user | async)?.uid == noticia.userId"
            style="color:grey; cursor: pointer;" mat-icon-button [matMenuTriggerFor]="menu">more_vert</mat-icon>
        </mat-card-header>
        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="eliminar(noticia)">
            <mat-icon>delete</mat-icon>
            Eliminar
          </button>
        </mat-menu>
        <br *ngIf="noticia.principal">
        <div *ngIf="noticia.principal">
          <img mat-card-image [src]="noticia.principal">
        </div>
        <mat-card-content>
          <mostrar-mas *ngIf="noticia.texto" class="text-justify" [texto]="noticia.texto" [largoMax]="250">
          </mostrar-mas>
          <div *ngIf="authService.user | async as user;">
            <div class="col-12" *ngIf="!checkMeGusta(noticia.megusta, user.uid)">
              <span *ngIf="noticia.megusta.length > 0" style="color: #00285C;">
                <i class="fa fa-thumbs-up"></i> Le gusta a {{ noticia.megusta.length }} </span>
              <span *ngIf="noticia.megusta.length == 1" style="color: #00285C;">
                vecino
              </span>
              <span *ngIf="noticia.megusta.length >= 2" style="color: #00285C;">
                vecinos
              </span>
            </div>
            <div class="col-12" *ngIf="checkMeGusta(noticia.megusta, user.uid)">
              <span style="color: #00285C;">
                <i class="fa fa-thumbs-up"></i> Te gusta</span>
              <span *ngIf="noticia.megusta.length > 1" style="color: #00285C;"> a ti y a {{ noticia.megusta.length -1
                }}</span>
              <span *ngIf="noticia.megusta.length == 2" style="color: #00285C;">
                vecino
              </span>
              <span *ngIf="noticia.megusta.length >= 3" style="color: #00285C;">
                vecinos
              </span>
            </div>
          </div>
          <br>
          <div class="row">
            <div class="col-6">
              <button mat-button class="boton" color="primary" routerLink="/iniciosesion"
                *ngIf="!(authService.user | async);">
                <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> Me gusta
              </button>
              <div *ngIf="authService.user | async as user;" class="boton">
                <button *ngIf="!checkMeGusta(noticia.megusta, user.uid)" style="width:100%" mat-button color="primary"
                  (click)="meGusta(noticia.id, noticia.megusta, user.uid)">
                  <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> Me gusta
                  <span class="badge badge-primary">{{noticia.megusta?.length}}</span>
                </button>
                <button *ngIf="checkMeGusta(noticia.megusta, user.uid)" style="width:100%" mat-raised-button
                  color="primary" (click)="eliminarMeGusta(noticia.id, noticia.megusta, user.uid)">
                  <i class="fa fa-thumbs-up" aria-hidden="true"></i> Me gusta
                  <span class="badge badge-primary">{{noticia.megusta?.length}}</span>
                </button>
              </div>
            </div>
            <div class="col-6">
              <button mat-button class="boton" color="primary" routerLink="/iniciosesion"
                *ngIf="!(authService.user | async);">
                <i class="material-icons icono-boton">comment</i>
                Comentarios
              </button>
              <button mat-button class="boton" color="primary" *ngIf="authService.user | async as user;">
                <i class="material-icons icono-boton">comment</i>
                Comentarios
                <span class="badge badge-primary">{{ noticia.comentarios?.length }}</span>
              </button>
            </div>
          </div>
          <div *ngIf="comentariosActivos()">
            <div *ngIf="authService.user | async as user">
              <br *ngIf="noticia.comentarios.length > this.revMax">
              <div class="col-12 text-center" *ngIf="noticia.comentarios.length > this.revMax ">
                <button mat-button (click)="cargarComentarios()">ðŸ’¬ Cargar mÃ¡s comentarios...
                  <span class="badge badge-primary">{{ noticia.comentarios?.length - this.revMax }}</span>
                </button>
              </div>
              <br>
              <div class="row"
                *ngFor="let comentario of (noticia.comentarios | slice: this.maxCom); trackBy: itemTrackBy;">
                <div class="col-2 col-md-2">
                  <p class="text-right">
                    <img class="rounded-circle" width="50px" height="50px"
                      src="{{(comentario.userRef | doc | async)?.photoURL || '../../../assets/user_google.jpg'}}">
                  </p>
                </div>
                <div class="col-8 col-md-8 comentario">
                  <b>{{ (comentario.userRef | doc | async)?.displayName }}</b>
                  <i style="color: grey; font-size:12px;" class="material-icons icono-boton">access_time</i>
                  <small style="opacity: 0.87;">ComentÃ³ {{ comentario.fecha | amTimeAgo }}</small>
                  <button *ngIf="(authService.user | async)?.admin" class="float-right" color="warn" mat-icon-button
                    matTooltip="Eliminar" (click)="eliminarComentario(comentario.id, noticia.comentarios, noticia.id)">
                    <i class="material-icons">delete</i>
                  </button>
                  <mostrar-mas *ngIf="comentario.comentario" class="text-justify" [texto]="comentario.comentario"
                    [largoMax]="200"></mostrar-mas>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="comentariosActivos()">
            <hr>
            <div class="row" *ngIf="authService.user | async as user;">
              <div class="col-2 col-md-2">
                <p class="text-right">
                  <img class="rounded-circle" width="50px;" height="50px;"
                    [src]="user.photoURL || '../../../assets/user_google.jpg'">
                </p>
              </div>
              <div class="col-10 col-md-10">
                <form [formGroup]="formulario" (ngSubmit)="comentar(noticia.id, user, noticia.comentarios)" novalidate>
                  <div class="example-container" style="margin-top:-15px;">
                    <mat-form-field floatLabel="never">
                      <textarea formControlName="texto" minlenght="1" matInput #texto
                        placeholder="Escribe un comentario..." matTextareaAutosize matAutosizeMinRows="3"
                        matAutosizeMaxRows="10" required></textarea>
                      <mat-hint *ngIf="texto.value.length > 500" align="end">{{texto.value.length}} / 500</mat-hint>
                      <mat-error *ngIf="texto.value.length < 1">Ingresa el comentario y presiona enviar.</mat-error>
                      <button *ngIf="texto.value.length > 0" mat-mini-fab color="primary" class="float-right"
                        type="submit" [disabled]="!formulario.valid" matTooltip="Enviar">
                        <i class="material-icons icono-boton">send</i>
                      </button>
                    </mat-form-field>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
<div class="container-fluid" style="padding-bottom:30px;" *ngIf="noticias$ | async as noticias">
  <div class="row" *ngIf="noticias?.length > this.maxNoticias">
    <div class="col-12 text-center">
      <button color="primary" mat-button (click)="cargarMasNoticias()">Cargar mÃ¡s publicaciones...</button>
    </div>
  </div>
  <div class="col-12 text-center" *ngIf="noticias?.length == 0">
    <br>
    <p>AÃºn no hay publicaciones en esta comunidad.</p>
  </div>
</div>
